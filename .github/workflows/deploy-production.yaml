name: Create Tag And Deploy In PROD_ENV

on:
  pull_request:
    branches:
      - master
    types: [closed]

jobs:
  create-Tag-Release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ç¡®ä¿è·å–æ‰€æœ‰å†å²ä»¥ä¾¿æ­£ç¡®ç”Ÿæˆæ ‡ç­¾

      - name: Setup Git
        run: |
          echo "ğŸ  Setting global git config informations"
          git config --global user.email "347258143@qq.com"
          git config --global user.name "Junlin-Robin"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Create and Push Tag
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # 2025-05-19è¿‡æœŸ
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ¤æ–­å½“å‰æ˜¯å¦æŒ‡å®šæŒ‡å®šç‰ˆæœ¬å·
          if [ -f 'merge-extra-info/.type' ] && grep -q 'VERSION_TYPE' 'merge-extra-info/.type'
          then
            VERSION_TYPE_EXIST=true
            VERSION_TYPE=$(grep 'VERSION_TYPE' '.versions/.type' | cut -d '=' -f2)
          else
            VERSION_TYPE=patch
          fi

          NEW_VERSION_TAG=$(npm version $VERSION_TYPE -m "Upgrade to %s due to merge feature branches")

          echo "-------------------------------------------------------------"

          echo "ğŸš€ å‡çº§ç‰ˆæœ¬ç±»å‹ä¸ºï¼š$VERSION_TYPEï¼Œå‡çº§åç‰ˆæœ¬å·ä¸ºï¼š$NEW_VERSION_TAG"

          echo "-------------------------------------------------------------"

          echo "ğŸ‘· Start move File..."
          mkdir -p .version/$NEW_VERSION_TAG

          if [ -f merge-extra-info/.type ]
          then
            mv merge-extra-info/.type ".version/${NEW_VERSION_TAG}/"
          fi

          mv merge-extra-info/log.md ".version/${NEW_VERSION_TAG}/"

          # è¾“å‡ºç‰ˆæœ¬å·åˆ°ç¯å¢ƒå˜é‡
          echo "NEW_VERSION_TAG=$NEW_VERSION_TAG" >> $GITHUB_ENV

          # æ¨é€æ›´æ–°ç‰ˆæœ¬å·å’Œ tag åˆ° master åˆ†æ”¯
          echo "ğŸš— æ¨é€æ›´æ–°ç‰ˆæœ¬å·å’Œ tag åˆ° master åˆ†æ”¯..."
          git push origin master --force
          git push origin $NEW_VERSION_TAG

      - name: Read Release Markdown File
        id: Read-Release-File
        run: |
          echo "ğŸ“– è¯»å–æ›´æ–°ç‰ˆæœ¬æ—¥å¿—æ–‡ä»¶..."
          CONTENT=$(cat '.versions/${{env.NEW_VERSION_TAG}}/log.md')
          CONTENT="${CONTENT//'%'/'%25'}"
          CONTENT="${CONTENT//$'\n'/'%0A'}"
          CONTENT="${CONTENT//$'\r'/'%0D'}"
          echo "::set-output name=CONTENT::$CONTENT"

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          release_name: Release ${{ env.TAG_NAME }}
          body: ${{ steps.Read-Release-File.outputs.CONTENT }}
          draft: false
          prerelease: false

  deploy-in-production:
    needs: [create-Tag-Release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ç¡®ä¿è·å–æ‰€æœ‰å†å²ä»¥ä¾¿æ­£ç¡®ç”Ÿæˆæ ‡ç­¾

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: checkout tag
        run: git checkout ${{ needs.create-tag.outputs.TAG }}

      - name: Install Dependencies
        run: yarn
      
      - name: Build
        id: build-environment
        run: |
          echo "ğŸ”§ å¼€å§‹é…ç½®æ‰“åŒ…ç¯å¢ƒ..."
          ENV=production
          echo "ENV=$ENV" >> $GITHUB_ENV

          OUT_DIR=$(grep 'REACT_BUILD_OUT_DIR' .env.$ENV | cut -d '=' -f2)
          echo "OUT_DIR=$OUT_DIR" >> $GITHUB_ENV

          echo "-------------------------------------------------------------"

          echo "å½“å‰ç¯å¢ƒä¸ºï¼šç”Ÿäº§ç¯å¢ƒï¼Œæ‰“åŒ…è¾“å‡ºç›®å½•ä¸ºï¼š$OUT_DIR ğŸ­"

          echo "-------------------------------------------------------------"

          echo "ğŸ“¦ å¼€å§‹å¯¹ vite é¡¹ç›®æ‰“åŒ…..."
          yarn run build -- --mode $ENV

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4.3.3
        with:
          branch: gh-pages     # éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
          folder: ${{ env.OUT_DIR }} # éƒ¨ç½²ç›®å½•è§é…ç½®
          target-folder: / # éƒ¨ç½²æ ¹ç›®å½•
          clean: true     # å…ˆæ¸…ç†ä¹‹å‰çš„éƒ¨ç½²
          token: ${{ secrets.GITHUB_TOKEN }}

    




      
